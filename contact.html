<!-- ... même début que précédemment ... -->

<script>
  function base64UrlDecode(str) {
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    while (str.length % 4) str += '=';
    return atob(str);
  }

  const params = new URLSearchParams(window.location.search);
  const dataB64 = params.get('data');
  const downloadBtn = document.getElementById('downloadBtn');
  const message = document.getElementById('message');

  if (!dataB64) {
    message.textContent = 'Erreur : données manquantes dans l’URL.';
    downloadBtn.style.display = 'none';
  } else {
    let contactData;
    try {
      const json = base64UrlDecode(dataB64);
      contactData = JSON.parse(json);
    } catch {
      message.textContent = 'Erreur : données invalides.';
      downloadBtn.style.display = 'none';
    }

    if (contactData) {
      let photoField = '';
      if (contactData.photo) {
        photoField = `PHOTO;ENCODING=b;TYPE=JPEG:${contactData.photo}\n`;
      }

      // Fonction / titre
      let titleField = '';
      if (contactData.jobTitle && contactData.jobTitle.length > 0) {
        titleField = `TITLE:${decodeURIComponent(contactData.jobTitle)}\n`;
      }

      // Sites web multiples
      let websitesFields = '';
      if (contactData.websites && contactData.websites.length > 0) {
        contactData.websites.forEach(site => {
          websitesFields += `URL;TYPE=WORK:${decodeURIComponent(site)}\n`;
        });
      }

      const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${decodeURIComponent(contactData.name)}
${titleField}TEL;TYPE=CELL:${decodeURIComponent(contactData.phone)}
EMAIL;TYPE=INTERNET:${decodeURIComponent(contactData.email)}
${websitesFields}${photoField}END:VCARD`;

      downloadBtn.addEventListener('click', () => {
        const blob = new Blob([vcard], {type: 'text/vcard'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = decodeURIComponent(contactData.name).replace(/\s+/g, '_') + '.vcf';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }, 100);
      });
    }
  }
</script>

